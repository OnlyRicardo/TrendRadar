name: Hot News Crawler

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

# ä½¿ç”¨Copilotå»ºè®®çš„å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true  # é¿å…å¹¶å‘å†²çª

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true  # æŒ‰Copilotå»ºè®®ï¼Œç§»é™¤æ˜¾å¼token

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            # å¦‚æœä½ å¸Œæœ› CI è‡ªåŠ¨è¿è¡Œï¼Œå¯ä»¥åœ¨æ­¤é€šè¿‡ secrets ç”Ÿæˆæ–‡ä»¶ï¼Œä¾‹å¦‚:
            # mkdir -p config
            # echo "${{ secrets.CONFIG_YAML }}" > config/config.yaml
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
            # åŒä¸Šï¼šå¯ç”¨ secrets å†™å…¥æ–‡ä»¶ä»¥é¿å…å¤±è´¥
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # ... å…¶ä»–ç¯å¢ƒå˜é‡
          GITHUB_ACTIONS: true
        run: python main.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add -A

          # æ”¹è¿›çš„å˜æ›´æ£€æµ‹ï¼šåŒæ—¶æ£€æŸ¥å·¥ä½œåŒºå’Œæš‚å­˜åŒº
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)"

          # ä½¿ç”¨åŠ¨æ€åˆ†æ”¯åï¼ˆä¼˜å…ˆä½¿ç”¨ github.ref_nameï¼Œå…¼é¡¾ detached head æƒ…å†µï¼‰
          BRANCH="${{ github.ref_name }}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "null" ]; then
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
          fi
          # å¦‚æœä»ç„¶æ˜¯ HEADï¼ˆdetachedï¼‰ï¼Œå°è¯•ä½¿ç”¨ä»“åº“é»˜è®¤åˆ†æ”¯ä½œä¸ºå›é€€ï¼ˆå¯æ ¹æ®ä½ ä»“åº“å®é™…é»˜è®¤åˆ†æ”¯æ”¹ä¸º main æˆ– masterï¼‰
          if [ "$BRANCH" = "HEAD" ]; then
            echo "âš ï¸ å½“å‰ä¸º detached HEADï¼Œå°è¯•ä½¿ç”¨ä»“åº“é»˜è®¤åˆ†æ”¯ä½œä¸ºå›é€€"
            BRANCH="${GITHUB_DEFAULT_BRANCH:-main}"
            echo "å›é€€ä½¿ç”¨åˆ†æ”¯: $BRANCH"
          fi
          echo "å½“å‰åˆ†æ”¯: $BRANCH"

          # è·å–è¿œç«¯æœ€æ–°å¹¶ rebaseï¼ˆå°½é‡é¿å…åˆå¹¶æäº¤ï¼‰
          git fetch origin "$BRANCH" || true
          git pull --rebase origin "$BRANCH" --autostash || true

          # å…ˆå°è¯•æ™®é€šæ¨é€ï¼›è‹¥è¢«æ‹’åˆ™ä½¿ç”¨å®‰å…¨å¼ºåˆ¶ï¼ˆ--force-with-leaseï¼‰
          echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          if ! git push origin "HEAD:${BRANCH}"; then
            echo "âš ï¸ æ™®é€šæ¨é€è¢«æ‹’ç»ï¼Œå°è¯•ä½¿ç”¨ --force-with-lease"
            git push --force-with-lease origin "HEAD:${BRANCH}"
          fi
